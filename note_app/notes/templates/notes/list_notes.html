{% extends "notes/base.html" %}
{% load static %}

{% block title %}Notes - BlockNotes{% endblock %}

{% block content %}
  <!-- Split layout -->
  <div class="row g-0">
    
    <!-- Sidebar (scrollable) -->
    <div class="col-md-4 border-end vh-100 d-flex flex-column" id="sidebar">
      <div class="p-3 border-bottom">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">My Notes</h5>
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createModal">+ New Note</button>
        </div>
        <form class="d-flex mt-3">
          <input class="form-control form-control-sm" type="search" placeholder="Search notes..." id="searchInput" value="{{ search_query }}">
        </form>
      </div>

      <!-- Sorting buttons -->
      <div class="d-flex justify-content-around p-2 border-bottom small">
        <a href="?sort=-created_at{% if search_query %}&q={{ search_query }}{% endif %}" class="text-decoration-none {% if sort_by == '-created_at' %}fw-bold{% endif %}">Newest</a>
        <a href="?sort=created_at{% if search_query %}&q={{ search_query }}{% endif %}" class="text-decoration-none {% if sort_by == 'created_at' %}fw-bold{% endif %}">Oldest</a>
        <a href="?sort=title{% if search_query %}&q={{ search_query }}{% endif %}" class="text-decoration-none {% if sort_by == 'title' %}fw-bold{% endif %}">A–Z</a>
        <a href="?sort=-title{% if search_query %}&q={{ search_query }}{% endif %}" class="text-decoration-none {% if sort_by == '-title' %}fw-bold{% endif %}">Z–A</a>
      </div>

      <!-- Notes list -->
      <div class="list-group list-group-flush overflow-auto">
        {% for note in notes %}
        <a href="#" class="list-group-item list-group-item-action note-item" data-note-id="{{ note.id }}" data-title="{{ note.title }}" data-content="{{ note.content }}">
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1 fw-bold">{{ note.title }}</h6>
          </div>
          <p class="mb-1 small text-muted">{{ note.content|truncatechars:70 }}</p>
          <small class="text-muted">{{ note.created_at|date:"M d, Y H:i" }}</small>
        </a>
        {% empty %}
        <div class="text-center p-5 text-muted">
          <p class="mb-0">No notes yet. Click "+ New Note" to create one!</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Main Pane -->
    <div class="col-md-8 vh-100 d-flex flex-column" id="mainPane">
      <div id="emptyState" class="p-5 text-center text-muted m-auto">
          <i class="bi bi-journal-text" style="font-size: 4rem;"></i>
          <h4 class="mt-3">Select a note to view it</h4>
          <p>Or create a new one to get started.</p>
      </div>
      <!-- View Mode -->
      <div id="noteView" class="d-none flex-grow-1 d-flex flex-column">
        <div class="note-header d-flex justify-content-between align-items-center p-3 border-bottom">
          <h2 id="noteTitle" class="fw-bold me-2 mb-0"></h2>
          <div>
            <button id="editBtn" class="btn btn-outline-secondary btn-sm me-2">Edit</button>
            <button id="deleteBtn" class="btn btn-outline-danger btn-sm me-2">Delete</button>
            <button id="receiptBtn" class="btn btn-outline-success btn-sm">Receipt</button>
          </div>
        </div>
        <div class="note-body p-4 overflow-auto">
          <p id="noteContent" class="note-content"></p>
        </div>
      </div>

      <!-- Edit Mode -->
      <div id="noteEdit" class="p-4 d-none flex-grow-1 d-flex flex-column overflow-auto">
        <form method="POST" id="editForm" class="d-flex flex-column flex-grow-1">
          {% csrf_token %}
          <input type="hidden" id="editNoteId" name="note_id">
          <div class="mb-3">
            <input type="text" class="form-control" id="editTitle" name="title" required placeholder="Title">
          </div>
          <div class="mb-3 flex-grow-1">
            <textarea class="form-control h-100" id="editContent" name="content" rows="10" required placeholder="Start writing..."></textarea>
          </div>
          <div>
            <button type="submit" class="btn btn-primary me-2">Save Changes</button>
            <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Create Modal -->
  <div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Note</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="POST" id="createNoteForm">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label for="createTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="createTitle" name="title" required>
            </div>
            <div class="mb-3">
              <label for="createContent" class="form-label">Content</label>
              <textarea class="form-control" id="createContent" name="content" rows="5" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Note</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let currentNoteId = null;
      const noteView = document.getElementById('noteView');
      const noteEdit = document.getElementById('noteEdit');
      const emptyState = document.getElementById('emptyState');

      // Function to show a view
      function showView(viewToShow) {
        noteView.classList.add('d-none');
        noteEdit.classList.add('d-none');
        emptyState.classList.add('d-none');
        if (viewToShow) {
          viewToShow.classList.remove('d-none');
        }
      }

      // Select a note
      document.querySelectorAll('.note-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          // Highlight active item
          document.querySelectorAll('.note-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');

          currentNoteId = item.dataset.noteId;
          document.getElementById('noteTitle').textContent = item.dataset.title;
          document.getElementById('noteContent').textContent = item.dataset.content;
          showView(noteView);
        });
      });

      // Edit button
      document.getElementById('editBtn').addEventListener('click', () => {
        showView(noteEdit);
        document.getElementById('editNoteId').value = currentNoteId;
        document.getElementById('editTitle').value = document.getElementById('noteTitle').textContent;
        document.getElementById('editContent').value = document.getElementById('noteContent').textContent;
      });

      // Cancel Edit
      document.getElementById('cancelEdit').addEventListener('click', () => {
        showView(noteView);
      });

      // Receipt Button
      document.getElementById('receiptBtn').addEventListener('click', () => {
          if (currentNoteId) {
              window.open(`/notes/verify/${currentNoteId}/`, '_blank');
          }
      });

      // Create Note (AJAX)
      const createNoteForm = document.getElementById('createNoteForm');
      if(createNoteForm) {
        createNoteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('{% url "notes:create_note" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createModal'));
                    if (modal) modal.hide();
                    this.reset();
                    window.location.reload(); // Reload to see new note and updated status
                } else {
                    alert('Error: ' + (data.error || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating note. Please try again.');
            });
        });
      }

      // Save Edit (AJAX)
      const editForm = document.getElementById('editForm');
      if(editForm) {
        editForm.addEventListener('submit', function(e) {
          e.preventDefault();
          fetch(`/notes/edit/${currentNoteId}/`, {
            method: 'POST',
            body: new FormData(this),
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              // Update view mode content
              document.getElementById('noteTitle').textContent = data.note.title;
              document.getElementById('noteContent').textContent = data.note.content;

              // Update sidebar item data and text
              let item = document.querySelector('.note-item[data-note-id="' + currentNoteId + '"]');
              item.dataset.title = data.note.title;
              item.dataset.content = data.note.content;
              item.querySelector('h6').textContent = data.note.title;
              item.querySelector('p').textContent = data.note.content.substring(0, 70);
              
              showView(noteView);
            }
          });
        });
      }

      // Delete
      document.getElementById('deleteBtn').addEventListener('click', () => {
          if (!currentNoteId) return;
          if (confirm("Are you sure you want to delete this note?")) {
              fetch(`/notes/delete/${currentNoteId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                    document.querySelector(`.note-item[data-note-id="${currentNoteId}"]`).remove();
                    currentNoteId = null;
                    showView(emptyState);
                }
              });
          }
      });

      // Search on form submit (to handle enter key)
      const searchForm = document.querySelector('#sidebar form');
      const searchInput = document.getElementById('searchInput');
      if(searchForm) {
        searchForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const query = searchInput.value;
          window.location.href = `{% url 'notes:list_notes' %}?q=${encodeURIComponent(query)}`;
        });
      }
    });
  </script>
{% endblock %}