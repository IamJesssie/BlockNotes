{% extends "notes/base.html" %}
{% load static %}

{% block title %}My Notes - BlockNotes{% endblock %}

{% block content %}
<div class="notes-app-container">
    <!-- Sidebar -->
    <aside class="notes-sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">My Notes</h2>
            <a href="#" class="btn-new-note" id="new-note-btn">+ New Note</a>
        </div>
        <div class="sidebar-status">
            <div class="blockchain-status-widget">
                <span class="glowing-dot"></span>
                <span id="blockchain-status-text">Blockchain Offline</span>
            </div>
        </div>
        <div class="sidebar-search">
            <input type="text" placeholder="Search notes...">
        </div>
        <div class="sidebar-sort">
            <span>Newest</span>
            <span>{{ notes|length }} notes</span>
        </div>
        <div class="notes-list" id="notes-list-container">
            {% for note in notes %}
            <div class="note-item" data-note-id="{{ note.id }}" data-note-title="{{ note.title }}" data-note-content="{{ note.content }}">
                <div class="note-item-header">
                    <h3>{{ note.title }}</h3>
                    <span class="note-options">...</span>
                </div>
                <p>{{ note.content|truncatechars:100 }}</p>
                <div class="note-item-footer">
                    <span>{{ note.created_at|timesince }} ago</span>
                    {% if note.blockchain_receipt %}
                        <span class="on-chain-badge">On-chain</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </aside>

    <!-- Main Content -->
    <main class="note-editor-pane" id="main-editor-pane">
        <div class="empty-state-editor">
            <div class="empty-state-icon-wrapper">
                <!-- SVG for empty state icon -->
            </div>
            <h3>Select a note to view it</h3>
            <p>Or create a new one to get started</p>
        </div>
        <!-- The note editor will appear here when a note is selected -->
    </main>
</div>

<!-- Modals -->
<div id="delete-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <p>Are you sure you want to delete this note?</p>
        <button id="confirm-delete-btn">Delete</button>
        <button id="cancel-delete-btn">Cancel</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const noteListContainer = document.getElementById('notes-list-container');
    const mainEditorPane = document.getElementById('main-editor-pane');
    const newNoteBtn = document.getElementById('new-note-btn');
    let activeNoteId = null;

    const emptyStateHTML = `
        <div class="empty-state-editor">
            <div class="empty-state-icon-wrapper">
                <svg width="40" height="40">...</svg> 
            </div>
            <h3>Select a note to view it</h3>
            <p>Or create a new one to get started</p>
        </div>`;

    function getEditorHTML(noteId, title, content, timestamp) {
        const isNewNote = !noteId;
        return `
            <div class="note-editor-view">
                <div class="note-editor-header">
                    <input type="text" id="note-editor-title" value="${title}" placeholder="Your note title...">
                    ${!isNewNote ? '<button id="on-blockchain-btn">On Blockchain</button>' : ''}
                </div>
                <div class="note-editor-meta">
                    <span>Last modified: ${timestamp}</span>
                    <input type="text" placeholder="Add tags (press Enter)">
                </div>
                <textarea id="note-editor-content" placeholder="Start typing your note...">${content}</textarea>
                <div class="editor-actions">
                    <button id="save-note-btn">Save Note</button>
                    ${!isNewNote ? '<button id="delete-note-btn">Delete</button>' : ''}
                </div>
            </div>
        `;
    }

    function renderEditor(noteId, title, content, timestamp) {
        mainEditorPane.innerHTML = getEditorHTML(noteId, title, content, timestamp);
        activeNoteId = noteId;
        attachEditorEventListeners();
    }

    function renderEmptyState() {
        mainEditorPane.innerHTML = emptyStateHTML;
        activeNoteId = null;
    }

    function attachEditorEventListeners() {
        const saveBtn = document.getElementById('save-note-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', handleSaveNote);
        }
        // ... other event listeners for delete, etc.
    }

    function handleSaveNote() {
        const title = document.getElementById('note-editor-title').value;
        const content = document.getElementById('note-editor-content').value;
        const url = activeNoteId ? `/notes/edit/${activeNoteId}/` : '{% url "notes:create_note" %}';
        const formData = new FormData();
        formData.append('title', title);
        formData.append('content', content);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(url, { method: 'POST', body: formData, headers: {'X-Requested-With': 'XMLHttpRequest'} })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error saving note.');
                }
            });
    }

    noteListContainer.addEventListener('click', function(e) {
        const noteItem = e.target.closest('.note-item');
        if (noteItem) {
            document.querySelectorAll('.note-item').forEach(item => item.classList.remove('active'));
            noteItem.classList.add('active');
            renderEditor(
                noteItem.dataset.noteId,
                noteItem.dataset.noteTitle,
                noteItem.dataset.noteContent,
                noteItem.querySelector('.note-item-footer span:first-child').textContent
            );
        }
    });

    newNoteBtn.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.note-item').forEach(item => item.classList.remove('active'));
        renderEditor(null, 'New Note', '', 'Just now');
    });

    // Initial render
    renderEmptyState();

    // Blockchain status polling
    const statusText = document.getElementById('blockchain-status-text');
    const glowingDot = document.querySelector('.glowing-dot');
    function checkBlockchainStatus() {
        fetch('{% url "notes:api_blockchain_status" %}')
            .then(response => response.json())
            .then(data => {
                if (data.is_connected) {
                    statusText.textContent = 'Blockchain Online';
                    glowingDot.style.backgroundColor = '#00D9FF';
                } else {
                    statusText.textContent = 'Blockchain Offline';
                    glowingDot.style.backgroundColor = '#dc3545';
                }
            });
    }
    setInterval(checkBlockchainStatus, 5000);
    checkBlockchainStatus();
});
</script>
{% endblock %}